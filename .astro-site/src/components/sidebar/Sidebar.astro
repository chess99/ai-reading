---
/**
 * å¸¸é©»ä¾§è¾¹æ  - ä½¿ç”¨ View Transitions å®ç°çœŸæ­£çš„å¸¸é©»æ•ˆæœ
 * å‚è€ƒ Obsidian çš„è®¾è®¡
 */
import { getCollection } from 'astro:content';
import { parseBookInfo } from '@/utils/bookParser';

// è·å–æ‰€æœ‰ä¹¦ç±æ•°æ®
const allBooks = await getCollection('books');

// æŒ‰åˆ†ç±»åˆ†ç»„
const booksByCategory = allBooks.reduce((acc, book) => {
  const relativePath = (book.filePath || book.id).replace(/^\.\.\/books\//, '');
  const info = parseBookInfo(relativePath);
  if (!acc[info.category]) {
    acc[info.category] = [];
  }
  acc[info.category].push({ ...book, info });
  return acc;
}, {} as Record<string, any[]>);

// åˆ†ç±»åˆ—è¡¨
const categories = Object.entries(booksByCategory)
  .map(([name, books]) => ({
    name,
    count: books.length,
    books: books.sort((a, b) => a.info.title.localeCompare(b.info.title, 'zh-CN')),
  }))
  .sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));

// è·å– base path
const base = import.meta.env.BASE_URL;

// åˆ†ç±»å›¾æ ‡
const categoryIcons: Record<string, string> = {
  'ä¸ªäººæˆé•¿': 'ğŸŒ±',
  'å¥åº·è¿åŠ¨': 'ğŸ’ª',
  'å•†ä¸šç®¡ç†': 'ğŸ’¼',
  'æŠ•èµ„': 'ğŸ’°',
  'å¿ƒç†å­¦': 'ğŸ§ ',
  'æ€ç»´æ–¹å¼': 'ğŸ¤”',
  'ç¤¾ä¼šç§‘å­¦': 'ğŸŒ',
};
---

<!-- ä½¿ç”¨ transition:persist ä½¿ä¾§è¾¹æ åœ¨é¡µé¢åˆ‡æ¢æ—¶ä¿æŒçŠ¶æ€ -->
<aside class="sidebar" id="sidebar" transition:persist="sidebar">
  <div class="sidebar-header">
    <button class="sidebar-toggle" id="sidebar-toggle" aria-label="æŠ˜å ä¾§è¾¹æ ">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
        <path
          d="M3 8h10M8 3l5 5-5 5"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
      </svg>
    </button>
  </div>

  <div class="sidebar-content">
    <!-- æ–‡ä»¶æ ‘ -->
    <nav class="file-tree">
      {
        categories.map((category) => (
          <div class="tree-folder" data-folder={category.name}>
            <button class="folder-header" data-category={category.name}>
              <svg class="folder-icon chevron" width="12" height="12" viewBox="0 0 12 12">
                <path
                  d="M4 2l4 4-4 4"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  fill="none"
                />
              </svg>
              <span class="folder-emoji">{categoryIcons[category.name] || 'ğŸ“š'}</span>
              <span class="folder-name">{category.name}</span>
              <span class="folder-count">{category.count}</span>
            </button>
            <div class="folder-content">
              {category.books.map((book) => {
                const slug = book.data.slug || book.id;
                return (
                  <a href={`${base}/books/${slug}`} class="file-item" data-slug={slug}>
                    <svg class="file-icon" width="12" height="12" viewBox="0 0 12 12">
                      <path
                        d="M2 1h5l3 3v6a1 1 0 01-1 1H2a1 1 0 01-1-1V2a1 1 0 011-1z"
                        stroke="currentColor"
                        stroke-width="1"
                        fill="none"
                      />
                    </svg>
                    <span class="file-name">{book.info.title}</span>
                  </a>
                );
              })}
            </div>
          </div>
        ))
      }
    </nav>
  </div>
</aside>

<script>
  // ä¾§è¾¹æ æŠ˜å é€»è¾‘
  function initSidebar() {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle');

    if (!sidebar || !toggleBtn) return;

    // ä» localStorage æ¢å¤çŠ¶æ€
    const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
    if (isCollapsed) {
      sidebar.classList.add('collapsed');
    }

    // æŠ˜å /å±•å¼€
    toggleBtn.addEventListener('click', () => {
      const collapsed = sidebar.classList.toggle('collapsed');
      localStorage.setItem('sidebar-collapsed', String(collapsed));
    });

    // æ–‡ä»¶å¤¹å±•å¼€/æŠ˜å 
    const folderHeaders = document.querySelectorAll('.folder-header');
    folderHeaders.forEach((header) => {
      header.addEventListener('click', (e) => {
        e.preventDefault();
        const folder = header.closest('.tree-folder');
        if (folder) {
          const isExpanded = folder.classList.toggle('expanded');
          const categoryName = header.getAttribute('data-category');
          if (categoryName) {
            // ä¿å­˜å±•å¼€çŠ¶æ€
            const expandedFolders = JSON.parse(
              localStorage.getItem('expanded-folders') || '[]'
            );
            if (isExpanded) {
              if (!expandedFolders.includes(categoryName)) {
                expandedFolders.push(categoryName);
              }
            } else {
              const index = expandedFolders.indexOf(categoryName);
              if (index > -1) {
                expandedFolders.splice(index, 1);
              }
            }
            localStorage.setItem('expanded-folders', JSON.stringify(expandedFolders));
          }
        }
      });
    });

    // æ¢å¤æ–‡ä»¶å¤¹å±•å¼€çŠ¶æ€
    const expandedFolders = JSON.parse(localStorage.getItem('expanded-folders') || '[]');
    expandedFolders.forEach((categoryName: string) => {
      const folder = document.querySelector(`[data-folder="${categoryName}"]`);
      if (folder) {
        folder.classList.add('expanded');
      }
    });

    // é«˜äº®å½“å‰æ–‡ä»¶
    const currentPath = window.location.pathname;
    const fileItems = document.querySelectorAll('.file-item');
    fileItems.forEach((item) => {
      if (item.getAttribute('href') === currentPath) {
        item.classList.add('active');
        // è‡ªåŠ¨å±•å¼€åŒ…å«å½“å‰æ–‡ä»¶çš„æ–‡ä»¶å¤¹
        const folder = item.closest('.tree-folder');
        if (folder) {
          folder.classList.add('expanded');
        }
      }
    });
  }

  // åˆå§‹åŒ–
  initSidebar();

  // View Transitions é¡µé¢åŠ è½½åé‡æ–°åˆå§‹åŒ–
  document.addEventListener('astro:page-load', () => {
    initSidebar();
  });
</script>

<style>
  .sidebar {
    position: fixed;
    top: 60px; /* Header é«˜åº¦ */
    left: 0;
    bottom: 0;
    width: 280px;
    background: var(--color-bg, #ffffff);
    border-right: 1px solid var(--color-border, #e1e4e8);
    display: flex;
    flex-direction: column;
    transition: width 0.25s ease;
    z-index: 40;
  }

  .sidebar.collapsed {
    width: 48px;
  }

  .sidebar-header {
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 0 8px;
    border-bottom: 1px solid var(--color-border, #e1e4e8);
    flex-shrink: 0;
  }

  .sidebar-toggle {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    color: var(--color-text-light, #7f8c8d);
    transition: all 0.2s;
  }

  .sidebar-toggle:hover {
    background: var(--color-bg-soft, #f8f9fa);
    color: var(--color-text, #2c3e50);
  }

  .sidebar.collapsed .sidebar-toggle svg {
    transform: rotate(180deg);
  }

  .sidebar-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .sidebar.collapsed .sidebar-content {
    opacity: 0;
    pointer-events: none;
  }

  /* æ–‡ä»¶æ ‘æ ·å¼ */
  .file-tree {
    padding: 8px 0;
  }

  .tree-folder {
    margin-bottom: 2px;
  }

  .folder-header {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 13px;
    color: var(--color-text, #2c3e50);
    transition: background-color 0.15s;
    text-align: left;
  }

  .folder-header:hover {
    background: var(--color-bg-soft, #f8f9fa);
  }

  .folder-icon {
    flex-shrink: 0;
    transition: transform 0.2s;
  }

  .tree-folder.expanded .folder-icon {
    transform: rotate(90deg);
  }

  .folder-emoji {
    font-size: 14px;
    flex-shrink: 0;
  }

  .folder-name {
    flex: 1;
    font-weight: 500;
  }

  .folder-count {
    font-size: 11px;
    color: var(--color-text-light, #7f8c8d);
    background: var(--color-bg-soft, #f8f9fa);
    padding: 2px 6px;
    border-radius: 10px;
  }

  .folder-content {
    display: none;
    padding-left: 24px;
  }

  .tree-folder.expanded .folder-content {
    display: block;
  }

  .file-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    font-size: 13px;
    color: var(--color-text, #2c3e50);
    text-decoration: none;
    border-radius: 4px;
    transition: all 0.15s;
    margin: 1px 0;
  }

  .file-item:hover {
    background: var(--color-bg-soft, #f8f9fa);
  }

  .file-item.active {
    background: var(--color-brand, #667eea);
    color: white;
  }

  .file-item.active .file-icon {
    color: white;
  }

  .file-icon {
    flex-shrink: 0;
    color: var(--color-text-light, #7f8c8d);
  }

  .file-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* æ»šåŠ¨æ¡æ ·å¼ */
  .sidebar-content::-webkit-scrollbar {
    width: 8px;
  }

  .sidebar-content::-webkit-scrollbar-track {
    background: transparent;
  }

  .sidebar-content::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 4px;
  }

  .sidebar-content::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
  }

  /* ç§»åŠ¨ç«¯éšè— */
  @media (max-width: 768px) {
    .sidebar {
      display: none;
    }
  }
</style>
