---
/**
 * æœç´¢é¢æ¿ç»„ä»¶ - é›†æˆ Pagefind å…¨æ–‡æœç´¢
 */
interface Props {
  baseUrl: string;
}

const { baseUrl } = Astro.props;
---

<div class="search-panel">
  <div class="search-header">
    <h3 class="search-title">æœç´¢</h3>
  </div>

  <div class="search-content">
    <div class="search-box">
      <input
        type="text"
        id="pagefind-search"
        class="search-input"
        placeholder="æœç´¢ä¹¦ç±å†…å®¹..."
        autocomplete="off"
      />
      <span class="search-icon">ğŸ”</span>
    </div>

    <div id="pagefind-results" class="search-results"></div>

    <div class="search-tips">
      <p class="tip-title">æœç´¢æŠ€å·§:</p>
      <ul>
        <li>è¾“å…¥å…³é”®è¯æœç´¢ä¹¦ç±å†…å®¹</li>
        <li>æ”¯æŒä¸­æ–‡åˆ†è¯æœç´¢</li>
        <li>æŒ‰ <kbd>Cmd/Ctrl+K</kbd> å¿«é€Ÿæ‰“å¼€æœç´¢</li>
      </ul>
    </div>
  </div>
</div>

<script is:inline>
  // ç®€åŒ–ç‰ˆæœç´¢ - ä½¿ç”¨ç°æœ‰çš„ pagefind å®ç°
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.querySelector('#pagefind-search');
    const resultsContainer = document.querySelector('#pagefind-results');

    if (!searchInput || !resultsContainer) return;

    let pagefindLoaded = false;

    async function loadPagefind() {
      if (pagefindLoaded) return;

      try {
        // åŠ¨æ€åˆ›å»º script æ ‡ç­¾åŠ è½½ pagefind
        const script = document.createElement('script');
        script.src = window.location.pathname.replace(/\/[^/]*$/, '') + '/pagefind/pagefind.js';
        document.head.appendChild(script);

        await new Promise((resolve, reject) => {
          script.onload = resolve;
          script.onerror = reject;
        });

        pagefindLoaded = true;
      } catch (error) {
        console.error('Failed to load pagefind:', error);
        throw error;
      }
    }

    searchInput.addEventListener('input', async (e) => {
      const query = e.target.value.trim();

      if (!query) {
        resultsContainer.innerHTML = '';
        return;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      resultsContainer.innerHTML = '<div class="search-loading">æœç´¢ä¸­...</div>';

      try {
        // ç¡®ä¿ pagefind å·²åŠ è½½
        if (!pagefindLoaded) {
          await loadPagefind();
        }

        // ç­‰å¾… pagefind åˆå§‹åŒ–
        if (typeof window.pagefind === 'undefined') {
          await new Promise((resolve) => setTimeout(resolve, 500));
        }

        if (typeof window.pagefind === 'undefined') {
          throw new Error('Pagefind not loaded');
        }

        const search = await window.pagefind.search(query);

        if (search.results.length === 0) {
          resultsContainer.innerHTML = '<div class="search-empty">æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</div>';
          return;
        }

        // åŠ è½½å‰ 10 ä¸ªç»“æœ
        const results = await Promise.all(
          search.results.slice(0, 10).map((r) => r.data())
        );

        resultsContainer.innerHTML = results
          .map(
            (result) => `
          <a href="${result.url}" class="search-result-item">
            <h4 class="result-title">${result.meta.title || 'æœªå‘½å'}</h4>
            <p class="result-excerpt">${result.excerpt || ''}</p>
          </a>
        `
          )
          .join('');
      } catch (error) {
        console.error('Search error:', error);
        resultsContainer.innerHTML = '<div class="search-error">æœç´¢å‡ºé”™ï¼Œè¯·ç¨åå†è¯•</div>';
      }
    });

    // ESC æ¸…ç©ºæœç´¢
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        searchInput.value = '';
        resultsContainer.innerHTML = '';
        searchInput.blur();
      }
    });
  });
</script>

<style>
  .search-panel {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }

  .search-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color, #e5e7eb);
    flex-shrink: 0;
  }

  .search-title {
    font-size: 14px;
    font-weight: 600;
    margin: 0;
    color: var(--text-color, #1f2937);
  }

  .search-content {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .search-box {
    position: relative;
    padding: 16px;
    flex-shrink: 0;
  }

  .search-input {
    width: 100%;
    padding: 10px 40px 10px 12px;
    font-size: 14px;
    border: 1px solid var(--border-color, #e5e7eb);
    border-radius: 8px;
    outline: none;
    transition: border-color 0.2s;
  }

  .search-input:focus {
    border-color: var(--primary-color, #3b82f6);
  }

  .search-icon {
    position: absolute;
    right: 28px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    opacity: 0.5;
  }

  .search-results {
    flex: 1;
    padding: 0 16px;
    overflow-y: auto;
  }

  .search-tips {
    padding: 16px;
    margin: 16px;
    background: var(--tips-bg, #f9fafb);
    border-radius: 8px;
    flex-shrink: 0;
  }

  .tip-title {
    font-size: 13px;
    font-weight: 600;
    margin: 0 0 8px 0;
    color: var(--text-color, #1f2937);
  }

  .search-tips ul {
    margin: 0;
    padding-left: 20px;
    font-size: 13px;
    color: var(--text-secondary, #6b7280);
    line-height: 1.6;
  }

  .search-tips kbd {
    display: inline-block;
    padding: 2px 6px;
    font-size: 11px;
    font-family: monospace;
    background: white;
    border: 1px solid var(--border-color, #e5e7eb);
    border-radius: 4px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  /* æœç´¢ç»“æœæ ·å¼ */
  .search-loading,
  .search-empty,
  .search-error {
    padding: 32px 16px;
    text-align: center;
    color: var(--text-secondary, #6b7280);
    font-size: 14px;
  }

  .search-error {
    color: #ef4444;
  }

  :global(.search-result-item) {
    display: block;
    padding: 12px;
    margin-bottom: 8px;
    background: var(--result-bg, #f9fafb);
    border-radius: 8px;
    border: 1px solid var(--border-color, #e5e7eb);
    text-decoration: none;
    transition: all 0.2s;
  }

  :global(.search-result-item:hover) {
    background: white;
    border-color: var(--primary-color, #3b82f6);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
  }

  :global(.result-title) {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-color, #1f2937);
    margin: 0 0 4px 0;
  }

  :global(.result-excerpt) {
    font-size: 13px;
    color: var(--text-secondary, #6b7280);
    line-height: 1.5;
    margin: 0;
  }

  :global(.result-excerpt mark) {
    background: #fef3c7;
    color: #92400e;
    padding: 2px 4px;
    border-radius: 2px;
  }

  /* æ»šåŠ¨æ¡æ ·å¼ */
  .search-content::-webkit-scrollbar,
  .search-results::-webkit-scrollbar {
    width: 6px;
  }

  .search-content::-webkit-scrollbar-track,
  .search-results::-webkit-scrollbar-track {
    background: transparent;
  }

  .search-content::-webkit-scrollbar-thumb,
  .search-results::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 3px;
  }

  .search-content::-webkit-scrollbar-thumb:hover,
  .search-results::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
  }
</style>
